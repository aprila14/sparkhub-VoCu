version: "3.7"

services:
  # Service for docker image build purpose only
  esp32-compile-image:
    image: esp32-compile-sparkhub
    build:
      context: .
      dockerfile: ./docker-build/compile.dockerfile
      target: compile
      args:
        USER_TO_USE_FOR_RUN: "user"
        UID: 1001

  # Service uses image from esp32-compile-image and builds binaries for ESP32
  esp32-container-build:
    image: esp32-compile-sparkhub
    volumes:
      - .:/media/src:rw
    command:
      - /bin/sh
      - -c
      - |
        dos2unix /media/src/docker-build/entry_script_build.sh
        /media/src/docker-build/entry_script_build.sh
    depends_on:
      - esp32-compile-image
